# 현장등록 기능 - 백엔드 변경 계획

## 1. DB 스키마 변경

### 1.1 SQL로 직접 컬럼 추가 (권장)
```sql
-- 두 DB 모두에서 실행
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);
```

**대상 DB:**
- `modulabs.ddns.net:25432` (개발)
- `backend.vibemakers.kr:23006` (운영)

### 1.2 Prisma 스키마 변경
**파일**: `prisma/schema.prisma`

```prisma
model User {
  id               String            @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  name             String            @db.VarChar(100)
  phoneLast4       String            @map("phone_last4") @db.VarChar(4)
  phone            String?           @db.VarChar(20)  // ← 추가
  email            String?           @db.VarChar(255)
  organization     String?           @db.VarChar(255)
  // ... 나머지 필드들
}
```

**주의**: `prisma db push`는 스키마에 없는 테이블(`sync_queue`, `sync_status`)을 삭제하려고 하므로 사용하지 말 것. SQL로 직접 컬럼 추가 권장.

---

## 2. authService.ts 수정

**파일**: `src/services/authService.ts`

### 2.1 RegisterInput 인터페이스 수정
```typescript
// 현장 등록
export interface RegisterInput {
  name: string;
  phone: string;  // 풀 전화번호로 변경 (기존: phone_last4)
  email?: string;
  organization?: string;
}
```

### 2.2 register 함수 수정
```typescript
export const register = async (input: RegisterInput): Promise<LoginResult | { error: string }> => {
  // 전화번호에서 숫자만 추출
  const phoneDigits = input.phone.replace(/\D/g, '');

  // 전화번호 뒷 4자리 추출
  const phoneLast4 = phoneDigits.slice(-4);

  if (phoneLast4.length !== 4) {
    return { error: 'INVALID_PHONE' };
  }

  // 중복 사용자 확인
  const existingUser = await prisma.user.findUnique({
    where: {
      unique_user: {
        name: input.name,
        phoneLast4: phoneLast4,
      },
    },
  });

  if (existingUser) {
    logger.warn(`Registration failed: User already exists (${input.name}, ${phoneLast4})`);
    return { error: 'USER_ALREADY_EXISTS' };
  }

  // 새 사용자 생성
  const user = await prisma.user.create({
    data: {
      name: input.name,
      phoneLast4: phoneLast4,
      phone: phoneDigits,  // 풀 전화번호 저장
      email: input.email || null,
      organization: input.organization || null,
      registrationType: 'onsite',
      lastLogin: new Date(),
    },
  });

  // JWT 토큰 생성
  const token = generateToken({
    userId: user.id,
    name: user.name,
  });

  // 세션 저장
  await prisma.authSession.create({
    data: {
      userId: user.id,
      token,
      expiresAt: getTokenExpiry(),
    },
  });

  logger.info(`New user registered (onsite): ${user.name} (${user.id})`);

  return {
    token,
    user: {
      id: user.id,
      name: user.name,
      phone_last4: user.phoneLast4,
      registration_type: user.registrationType,
      has_signature: false,
    },
  };
};
```

---

## 3. authController.ts 수정

**파일**: `src/controllers/authController.ts`

### 3.1 register 컨트롤러 수정
```typescript
// 현장 등록
export const register = async (req: Request, res: Response) => {
  try {
    const { name, phone, email, organization } = req.body;

    // 입력 검증
    if (!name || !phone) {
      return errorResponse(res, '이름과 전화번호는 필수입니다', 400, 'INVALID_INPUT');
    }

    // 전화번호 숫자만 추출하여 길이 검증
    const phoneDigits = phone.replace(/\D/g, '');
    if (phoneDigits.length < 10 || phoneDigits.length > 11) {
      return errorResponse(res, '올바른 전화번호 형식이 아닙니다', 400, 'INVALID_PHONE');
    }

    // 등록 시도
    const result = await authService.register({ name, phone, email, organization });

    if ('error' in result) {
      if (result.error === 'USER_ALREADY_EXISTS') {
        return errorResponse(res, '이미 등록된 사용자입니다. 로그인을 시도해주세요.', 409, 'USER_ALREADY_EXISTS');
      }
      if (result.error === 'INVALID_PHONE') {
        return errorResponse(res, '올바른 전화번호 형식이 아닙니다', 400, 'INVALID_PHONE');
      }
      return errorResponse(res, '등록에 실패했습니다', 500, result.error);
    }

    successResponse(res, result, '현장 등록이 완료되었습니다');
  } catch (error) {
    logger.error('Register error:', error);
    errorResponse(res, '현장 등록에 실패했습니다', 500, 'REGISTER_FAILED');
  }
};
```

---

## 4. auth.ts 라우터 (이미 완료)

**파일**: `src/routes/auth.ts`

```typescript
// 이미 추가됨
router.post('/register', authController.register);
```

---

## 5. 작업 순서 요약

1. **DB**: 두 DB에 phone 컬럼 추가 (SQL 직접 실행)
2. **Prisma**: schema.prisma에 phone 필드 추가
3. **authService.ts**: RegisterInput, register 함수 수정
4. **authController.ts**: register 컨트롤러 수정
5. **테스트**: API 테스트

## 6. API 사용 예시

### Request
```bash
POST /api/auth/register
Content-Type: application/json

{
  "name": "홍길동",
  "phone": "010-1234-5678",
  "email": "hong@example.com",
  "organization": "모두의연구소"
}
```

### Response (성공)
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": "uuid-here",
      "name": "홍길동",
      "phone_last4": "5678",
      "registration_type": "onsite",
      "has_signature": false
    }
  },
  "message": "현장 등록이 완료되었습니다"
}
```

### Response (중복)
```json
{
  "success": false,
  "error": {
    "code": "USER_ALREADY_EXISTS",
    "message": "이미 등록된 사용자입니다. 로그인을 시도해주세요."
  }
}
```
