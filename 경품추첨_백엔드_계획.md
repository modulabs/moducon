# 경품 추첨 기능 백엔드 구현 계획

## 1. DB 스키마 변경

### User 테이블에 컬럼 추가
```sql
-- 추첨권 번호 (서명 완료자에게만 부여)
ALTER TABLE users ADD COLUMN lottery_number INT;

-- 당첨 여부 (중복 당첨 방지용)
ALTER TABLE users ADD COLUMN lottery_won BOOLEAN DEFAULT FALSE;

-- 인덱스 추가
CREATE INDEX idx_users_lottery ON users(lottery_number) WHERE lottery_number IS NOT NULL;
```

### 추첨권 번호 할당 (서명 완료자만, 등록 순서대로)
```sql
UPDATE users
SET lottery_number = numbered.row_num
FROM (
  SELECT u.id, ROW_NUMBER() OVER (ORDER BY u.registered_at) as row_num
  FROM users u
  INNER JOIN signatures s ON u.id = s.user_id
) AS numbered
WHERE users.id = numbered.id;
```

---

## 2. Prisma 스키마 수정

```prisma
model User {
  // ... 기존 필드들
  lotteryNumber    Int?      @map("lottery_number")
  lotteryWon       Boolean   @default(false) @map("lottery_won")
  // ...
}
```

---

## 3. API 엔드포인트

### GET /api/admin/lottery/participants
추첨 대상자 목록 조회 (서명 완료 + 추첨권 번호 있는 사람)

```typescript
// Response
{
  success: true,
  data: {
    participants: [
      {
        id: "uuid",
        name: "홍길동",
        phoneLast4: "1234",
        lotteryNumber: 1,
        lotteryWon: false
      },
      // ...
    ],
    stats: {
      total: 500,        // 전체 추첨 대상자
      remaining: 495,    // 미당첨자
      won: 5             // 당첨자
    }
  }
}
```

### POST /api/admin/lottery/draw
랜덤 추첨 실행

```typescript
// Request
{
  excludeWinners: true  // 기존 당첨자 제외 (기본값: true)
}

// Response
{
  success: true,
  data: {
    winner: {
      id: "uuid",
      name: "홍길동",
      phoneLast4: "1234",
      lotteryNumber: 42
    }
  }
}
```

### POST /api/admin/lottery/reset
당첨 기록 초기화 (필요시)

```typescript
// Response
{
  success: true,
  data: {
    resetCount: 5  // 초기화된 당첨자 수
  }
}
```

---

## 4. 구현 코드 예시

### routes/admin.ts에 추가

```typescript
// 추첨 대상자 목록
router.get('/lottery/participants', adminAuth, async (req, res) => {
  const participants = await prisma.user.findMany({
    where: {
      lotteryNumber: { not: null }
    },
    select: {
      id: true,
      name: true,
      phoneLast4: true,
      lotteryNumber: true,
      lotteryWon: true
    },
    orderBy: { lotteryNumber: 'asc' }
  });

  const stats = {
    total: participants.length,
    remaining: participants.filter(p => !p.lotteryWon).length,
    won: participants.filter(p => p.lotteryWon).length
  };

  res.json({ success: true, data: { participants, stats } });
});

// 추첨 실행
router.post('/lottery/draw', adminAuth, async (req, res) => {
  const { excludeWinners = true } = req.body;

  const eligible = await prisma.user.findMany({
    where: {
      lotteryNumber: { not: null },
      ...(excludeWinners ? { lotteryWon: false } : {})
    },
    select: {
      id: true,
      name: true,
      phoneLast4: true,
      lotteryNumber: true
    }
  });

  if (eligible.length === 0) {
    return res.status(400).json({
      success: false,
      error: { message: '추첨 가능한 대상자가 없습니다.' }
    });
  }

  // 랜덤 선택
  const randomIndex = Math.floor(Math.random() * eligible.length);
  const winner = eligible[randomIndex];

  // 당첨 기록
  await prisma.user.update({
    where: { id: winner.id },
    data: { lotteryWon: true }
  });

  res.json({ success: true, data: { winner } });
});

// 당첨 기록 초기화
router.post('/lottery/reset', adminAuth, async (req, res) => {
  const result = await prisma.user.updateMany({
    where: { lotteryWon: true },
    data: { lotteryWon: false }
  });

  res.json({ success: true, data: { resetCount: result.count } });
});
```

---

## 5. 실행 순서

1. **DB에 컬럼 추가** (SQL 직접 실행)
2. **추첨권 번호 할당** (SQL 직접 실행)
3. **Prisma 스키마 업데이트** 후 `npx prisma generate`
4. **API 엔드포인트 추가**
5. **서버 재시작**

---

## 6. 마이페이지 API 수정

### GET /api/mypage 응답에 추첨권 번호 추가

```typescript
// 기존 응답에 lotteryNumber 필드 추가
{
  success: true,
  data: {
    user: {
      id: "uuid",
      name: "홍길동",
      signatureUrl: null,
      signatureData: "data:image/png;base64,...",
      registrationType: "pre_registered",
      registeredAt: "2024-12-13T10:00:00Z",
      lotteryNumber: 42  // 추가! (서명 완료자만, 없으면 null)
    },
    // ... 기존 필드들
  }
}
```

### 구현 코드

```typescript
// routes/mypage.ts 수정
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: {
    id: true,
    name: true,
    signatureUrl: true,
    registrationType: true,
    registeredAt: true,
    lotteryNumber: true,  // 추가
    signatures: {
      select: { signatureData: true }
    }
  }
});
```

---

## 7. 새로운 서명 완료자 처리

현장에서 새로 서명하는 사람에게도 추첨권 부여 필요.
서명 API에서 추첨권 자동 할당:

```typescript
// 서명 저장 후
const maxNumber = await prisma.user.aggregate({
  _max: { lotteryNumber: true }
});
const nextNumber = (maxNumber._max.lotteryNumber || 0) + 1;

await prisma.user.update({
  where: { id: userId },
  data: { lotteryNumber: nextNumber }
});
```
