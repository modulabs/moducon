generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  name             String            @db.VarChar(100)
  phoneLast4       String            @map("phone_last4") @db.VarChar(4)
  phone            String?           @db.VarChar(20)
  email            String?           @db.VarChar(255)
  organization     String?           @db.VarChar(255)
  signatureUrl     String?           @map("signature_url")
  registrationType String            @default("pre_registered") @map("registration_type") @db.VarChar(20)
  registeredAt     DateTime          @default(now()) @map("registered_at") @db.Timestamptz(6)
  lastLogin        DateTime?         @map("last_login") @db.Timestamptz(6)
  isActive         Boolean           @default(true) @map("is_active")
  updatedAt        DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  authSessions     AuthSession[]
  signatures       Signature?
  checkins         UserCheckin[]
  quizAttempts     UserQuizAttempt[]
  questions        Question[]
  questionLikes    QuestionLike[]
  favorites        UserFavorite[]

  @@unique([name, phoneLast4], name: "unique_user")
  @@index([name, phoneLast4], map: "idx_users_name_phone")
  @@map("users")
}

model AuthSession {
  id        String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  isRevoked Boolean  @default(false) @map("is_revoked")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token], map: "idx_auth_token")
  @@map("auth_sessions")
}

model Signature {
  id            String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId        String   @unique @map("user_id") @db.Uuid
  signatureData String   @map("signature_data")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("signatures")
}

model Admin {
  id           String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  username     String   @unique @db.VarChar(50)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("admins")
}

model UserCheckin {
  id          String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  targetType  String   @map("target_type") @db.VarChar(20)
  targetId    String   @map("target_id") @db.VarChar(50)
  checkedInAt DateTime @default(now()) @map("checked_in_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId], name: "unique_checkin")
  @@index([userId], map: "idx_checkins_user")
  @@index([targetType, targetId], map: "idx_checkins_target")
  @@map("user_checkins")
}

model Quiz {
  id            String            @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  targetType    String            @map("target_type") @db.VarChar(20)
  targetId      String            @map("target_id") @db.VarChar(50)
  question      String
  options       String[]          @db.VarChar(255)
  correctAnswer Int               @map("correct_answer")
  isActive      Boolean           @default(true) @map("is_active")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  attempts      UserQuizAttempt[]

  @@unique([targetType, targetId], name: "unique_quiz_target")
  @@index([targetType, targetId], map: "idx_quiz_target")
  @@map("quizzes")
}

model UserQuizAttempt {
  id          String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  quizId      String   @map("quiz_id") @db.Uuid
  answer      Int
  isCorrect   Boolean  @map("is_correct")
  attemptedAt DateTime @default(now()) @map("attempted_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_attempts_user")
  @@index([quizId], map: "idx_attempts_quiz")
  @@map("user_quiz_attempts")
}

model Session {
  id                String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  code              String   @unique @db.VarChar(20)
  track             String   @db.VarChar(50)
  location          String   @db.VarChar(100)
  timeSlot          String   @map("time_slot") @db.VarChar(50)
  speakerName       String   @map("speaker_name") @db.VarChar(200)
  speakerOrg        String?  @map("speaker_org") @db.VarChar(500)
  speakerBio        String?  @map("speaker_bio")
  speakerProfileUrl String?  @map("speaker_profile_url")
  title             String   @db.VarChar(500)
  description       String?
  keywords          String[] @db.VarChar(100)
  pageUrl           String?  @map("page_url")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([track], map: "idx_sessions_track")
  @@index([code], map: "idx_sessions_code")
  @@map("sessions")
}

model Booth {
  id               String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  code             String   @unique @db.VarChar(20)
  name             String   @db.VarChar(200)
  organization     String?  @db.VarChar(200)
  orgType          String?  @map("org_type") @db.VarChar(50)
  description      String?
  boothDescription String?  @map("booth_description")
  hashtags         String[] @db.VarChar(100)
  solutions        String?
  coreTech         String?  @map("core_tech")
  researchGoals    String?  @map("research_goals")
  mainProducts     String?  @map("main_products")
  demoContent      String?  @map("demo_content")
  imageUrl         String?  @map("image_url")
  managerName      String?  @map("manager_name") @db.VarChar(100)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([code], map: "idx_booths_code")
  @@map("booths")
}

model Poster {
  id               String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  code             String   @unique @db.VarChar(20)
  title            String
  abstract         String?
  researcher       String?  @db.VarChar(200)
  affiliation      String?  @db.VarChar(300)
  hashtags         String[] @db.VarChar(100)
  presentationTime String?  @map("presentation_time") @db.VarChar(100)
  location         String?  @db.VarChar(100)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([code], map: "idx_posters_code")
  @@map("posters")
}

// =============================================
// Q&A 시스템 모델
// =============================================

model Question {
  id          String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  targetType  String   @map("target_type") @db.VarChar(20) // 'session', 'booth', 'paper'
  targetId    String   @map("target_id") @db.VarChar(50)
  content     String   @db.Text
  isAnonymous Boolean  @default(false) @map("is_anonymous")
  isAnswered  Boolean  @default(false) @map("is_answered")
  isPinned    Boolean  @default(false) @map("is_pinned")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes  QuestionLike[]
  answer QuestionAnswer?

  @@index([targetType, targetId], map: "idx_questions_target")
  @@index([userId], map: "idx_questions_user")
  @@index([createdAt], map: "idx_questions_created")
  @@map("questions")
}

model QuestionLike {
  id         String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questionId, userId], name: "unique_question_like")
  @@index([questionId], map: "idx_likes_question")
  @@index([userId], map: "idx_likes_user")
  @@map("question_likes")
}

model QuestionAnswer {
  id         String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  questionId String   @unique @map("question_id") @db.Uuid
  content    String   @db.Text
  answeredBy String?  @map("answered_by") @db.VarChar(100)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_answers")
}

// =============================================
// 관심 등록 (즐겨찾기) 모델
// =============================================

model UserFavorite {
  id         String   @id @default(dbgenerated("uuid_v7()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  targetType String   @map("target_type") @db.VarChar(20) // 'session', 'booth', 'paper'
  targetId   String   @map("target_id") @db.VarChar(50)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId], name: "unique_favorite")
  @@index([userId], map: "idx_favorites_user")
  @@index([targetType, targetId], map: "idx_favorites_target")
  @@map("user_favorites")
}
