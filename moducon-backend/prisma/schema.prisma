generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid()) @db.Uuid
  name             String            @db.VarChar(100)
  phoneLast4       String            @map("phone_last4") @db.VarChar(4)
  email            String?           @db.VarChar(255)
  organization     String?           @db.VarChar(255)
  signatureUrl     String?           @map("signature_url")
  registrationType String            @default("pre_registered") @map("registration_type") @db.VarChar(20)
  registeredAt     DateTime          @default(now()) @map("registered_at") @db.Timestamptz(6)
  lastLogin        DateTime?         @map("last_login") @db.Timestamptz(6)
  isActive         Boolean           @default(true) @map("is_active")
  authSessions     AuthSession[]
  signatures       Signature?
  checkins         UserCheckin[]
  quizAttempts     UserQuizAttempt[]

  @@unique([name, phoneLast4], name: "unique_user")
  @@index([name, phoneLast4], map: "idx_users_name_phone")
  @@map("users")
}

model AuthSession {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  isRevoked Boolean  @default(false) @map("is_revoked")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token], map: "idx_auth_token")
  @@map("auth_sessions")
}

model Signature {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @unique @map("user_id") @db.Uuid
  signatureData String   @map("signature_data")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("signatures")
}

model Admin {
  id           String   @id @default(uuid()) @db.Uuid
  username     String   @unique @db.VarChar(50)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("admins")
}

model UserCheckin {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  targetType  String   @map("target_type") @db.VarChar(20) // 'session', 'booth', 'paper'
  targetId    String   @map("target_id") @db.VarChar(50)
  checkedInAt DateTime @default(now()) @map("checked_in_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetType, targetId], name: "unique_checkin")
  @@index([userId], map: "idx_checkins_user")
  @@index([targetType, targetId], map: "idx_checkins_target")
  @@map("user_checkins")
}

model Quiz {
  id            String            @id @default(uuid()) @db.Uuid
  targetType    String            @map("target_type") @db.VarChar(20) // 'session', 'booth', 'paper'
  targetId      String            @map("target_id") @db.VarChar(50)
  question      String            @db.Text
  options       String[]          @db.VarChar(255)
  correctAnswer Int               @map("correct_answer") // 정답 인덱스 (0-3)
  isActive      Boolean           @default(true) @map("is_active")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  attempts      UserQuizAttempt[]

  @@unique([targetType, targetId], name: "unique_quiz_target")
  @@index([targetType, targetId], map: "idx_quiz_target")
  @@map("quizzes")
}

model UserQuizAttempt {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  quizId      String   @map("quiz_id") @db.Uuid
  answer      Int // 사용자 답변 (0-3)
  isCorrect   Boolean  @map("is_correct")
  attemptedAt DateTime @default(now()) @map("attempted_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_attempts_user")
  @@index([quizId], map: "idx_attempts_quiz")
  @@map("user_quiz_attempts")
}
